<!DOCTYPE html>
<html>
<head>
	<title>Ping Pong Game</title>
</head>
<body>
	<canvas id="canvas" width="1300" height="500" style="border: solid black;width: 100%;"></canvas>
	<script type="module" src="js/app.js"></script>

	<script type="module">
		import {app, startBallPosition, collision, resize, playersKeyCommands, beepSound, updatePlayerAndScore} from './js/app.js'
		
		//Sample functions, remove these functions and design ping-pong game with onInit and onUpdate.
		app.onInit = function(){
			//VARIABLES
			const PLAYER_PADDLE_HEIGHT = 150;
			const PLAYER_PADDLE_WIDTH = 50;
			const PADDLE_INITIAL_POSITION = app.height/2 - 150/2;
			const BALL_WIDTH = 50;
			const BALL_HEIGHT = 50;
			const BALL_RADIUS = 20;

			this.nodes.push({
				id : 'red-box',
				width  : BALL_WIDTH,
				height : BALL_HEIGHT,
				color  : 'red',
				// speed: 10,
				r: BALL_RADIUS,
			});
			startBallPosition(this)
			
			this.nodes.push({
				id : 'player-one',
				x  : 0,
				y  : PADDLE_INITIAL_POSITION,
				width  : PLAYER_PADDLE_WIDTH,
				height : PLAYER_PADDLE_HEIGHT,
				color  : 'black',
				score: 0
			});
			
			this.nodes.push({
				id : 'player-two',
				x  : app.width - PLAYER_PADDLE_WIDTH,
				y  : PADDLE_INITIAL_POSITION,
				width  : PLAYER_PADDLE_WIDTH,
				height : PLAYER_PADDLE_HEIGHT,
				color  : 'blue',
				score: 0
			});

			this.nodes.push({
				id : 'player-two-score',
				x  : 3 * app.width / 4,
				y  : app.height / 5,
				color  : 'blue',
				text: 0
			});

			this.nodes.push({
				id : 'player-one-score',
				x  : app.width / 4,
				y  : app.height / 5,
				color  : 'black',
				text: 0
			});
			
			//event listener to detect the pressed keys from the client
			document.addEventListener('keydown', playersKeyCommands)
			//event listener to detect the resize of the window
			window.addEventListener('resize', resize)
		};
		
		app.onUpdate = function(time){
			/*setting up variables*/
			let playerOne = this.getNode("player-one")
			let playerTwo = this.getNode("player-two")
			let ball = this.getNode('red-box')

			//player one overlaping controlls
			const didPlayerOneReachTopMostLine = playerOne.y < 0;
			const didPlayerOneReachBottomMostLine = playerOne.y >= this.height - playerOne.height;

			//player two overlaping controlls
			const didPlayerTwoReachTopMostLine = playerTwo.y < 0;
			const didPlayerTwoReachBottomMostLine = playerTwo.y >= this.height - playerTwo.height;

			/*this is to deter the players paddle overlaping*/
			if(didPlayerOneReachTopMostLine){
				playerOne.y = 0
			}

			if(didPlayerOneReachBottomMostLine){
				playerOne.y = this.height - playerOne.height
			}

			if(didPlayerTwoReachTopMostLine){
				playerTwo.y = 0
			}

			if(didPlayerTwoReachBottomMostLine){
				playerTwo.y = this.height - playerTwo.height
			}

			/*Ball bouncing logic*/
			ball.x += ball.directionX;
			ball.y += ball.directionY;
			
			/*Detect in what side the ball is*/
			let isBallInPlayerOneField = ball.x < this.width / 2 
			let player = isBallInPlayerOneField ? playerOne : playerTwo

			/*We change the direction based on where the ball hit the paddle*/
			if(collision(ball, player)){
				let collidePoint = (ball.y - (player.y + player.height / 2)) / (player.height/2)
				let angle = collidePoint * (Math.PI / 4)

				//if direction is 1 is going from left to right
				//if direction is 1 is going from rigth to left
				let direction = (ball.x < this.width / 2 ) ? 1 : -1

				ball.directionX = direction * ball.speed * Math.cos(angle)
				ball.directionY = direction * ball.speed * Math.sin(angle)

				//increment the speed of the ball
				ball.speed += 1
			}

			let didBallHitBounce = ball.y + ball.r > this.height || ball.y < 0
			/*Re-directing after hitting either upper-bounce or lower-bounce*/
			if(didBallHitBounce){
				ball.directionY = -ball.directionY;
			}

			/*Reseting after hitting a player side*/
			let didBallHitPlayerOneSide = ball.x < 0
			let didBallHitPlayerTwoSide = ball.x + ball.r > this.width

			//if the ball hit the player-one side, player-two score increments
			if(didBallHitPlayerOneSide){
				// Get current player score
				let playerScore = this.getNode("player-two-score") 

				// Update score player two and reset game
				updatePlayerAndScore(playerTwo, playerScore)
				startBallPosition(this)
				beepSound();
			}

			//if the ball hit the player-two side, player-one score increments
			else if(didBallHitPlayerTwoSide){
				// Get current player score
				let playerScore = this.getNode("player-one-score") 
				
				// Update score player one and reset game
				updatePlayerAndScore(playerOne, playerScore)
				startBallPosition(this)
				beepSound();
			}

		};

		// pause function. Freeze the game, it is needed the id returned by the requestAnimationFrame to cancel it and pause
		app.pause = function(){

			let isAnimationRunning = this.idStop

			if(isAnimationRunning){
				//the animation frame is cancelled by passing the idStop retrived from requestAnimationFrame in app.js
				cancelAnimationFrame(this.idStop)
				//if this.idStop is null, the game is paused
				this.idStop = null
			}
			else{
				//if there is no id, a new requestAnimationFrame is created
				window.requestAnimationFrame(this.render.bind(this))
			}
		};

		// reset function, starts from zero the players scores
		app.reset = function(){
			this.nodes = []
			this.onInit()
		}


	</script>
</body>
</html>